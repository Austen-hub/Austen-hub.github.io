# 数据库系统实践
## 06触发器和事务管理
#### 1. 触发器
###### 举例
- 请使⽤“⼀……就……”的句型造句
    + ⼀玩起游戏，就废寝忘⾷
    + 上数据库实践课，就晕⻋
    + ⿏标⼀点击菜单项，就弹出设置对话框
    + Windows事件驱动
        * 你点什么按钮（即产⽣什么事件），电脑执⾏什么操作（即调⽤什么函数）
![触发器举例](https://github.com/Austen-hub/Austen-hub.github.io/blob/master/basicCourse/images/%E6%95%B0%E6%8D%AE%E5%BA%93%E7%B3%BB%E7%BB%9F%E5%AE%9E%E8%B7%B5-%E8%A7%A6%E5%8F%91%E5%99%A8%E4%B8%BE%E4%BE%8B.jpg?raw=true)  
###### 创建并使用触发器
- 触发器
    + 定义一系列操作（触发程序）
    + 触发事件发生→触发程序自动运行
    + 用于检测数据表添、删、改操作
    + 激活触发程序
    + 实现数据自动维护
- 创建触发器语法
```sql
CREATE TRIGGER trigger_name
    {BEFORE|AFTER}
    {UPDATE|INSERT|DELETE}
ON table_name
FOR EACH ROW
trigger_statements
```
    + 语法说明
        * trigger_name
            - 触发器名称，当前库中唯一
        *  BEFORE | AFTER
            -  触发时机
        *  UPDATE | INSERT | DELETE
            -  触发类型
        *  table_name
            -  触发器关联数据表
            -  永久表，非临时表或视图
            -  时机+类型：唯一
        *  FOR EACH ROW
            - 提醒：针对每行都触发
        * trigger_statements
            - 触发程序体
            - 可使用BEGIN...END结构
            - 同存储过程结构
- 字段值的引用
    + OLD
        * 原字段值
    + NEW
        * 新字段值
    + INSERT
        * 只有NEW字段值
    + UPDATE
        * 修改前是OLD原值
        * 修改后是NEW新值
    + DELETE
        * 只有OLD原值
```sql
#添加交易记录检查。交易⾦额必须不超过500，否则，不“添加”记录
DELIMITER $$
CREATE TRIGGER
    tr_translog_before_insert
    BEFORE INSERT ON translog
    FOR EACH ROW
BEGIN
    IF(NEW.amount<=500)
    THEN
        SET NEW.amount=NEW.amount;
    ELSE    #⾮法，执⾏⾮法语句，使失败退出
        INSERT INTO mytable VALUES(0);
    END IF;
END;
$$
DELIMITER ;
```
###### 查看触发器
- 方法1：命令
    + SHOW TRIGGERS [LIKE 'ptn']
    + 只查当前库
    + LIKE匹配数据表名
- 方法2：查表
    + information_schema.triggers
    + 查所有库
    + select * from information_schema.triggers;
- 方法3：命令
    + SHOW CREATE TRIGGER
    + 只看一个触发器
###### 删除触发器
- DROP TRIGGER　trigger_name
    + 说明
        * 权限要求：trigger
        * 删表→删触发器
            - 隶属于数据库
            - 依附于数据表
            - 皮之不存，毛将焉附
        * 没有“修改”
            - 先删除后新建
###### 触发器的应用
- 注意事项
    + 触发程序不能返回结果集（区别于存储过程）
    + 不能重复：（数据表+触发时机+触发类型）
    + 触发程序：不⽀持事务语句，例如：
        * START TRANSACTION
        * COMMIT
        * ROLLBACK
        * SET AUTOCOMMIT=0
    + ⾏级检测
        * 批量操作将致性能降低
    + MyISAM不⽀持事务，不保证原⼦性
        * 例：前触发、操作、后触发，任⼀失败，均不能撤销回滚
    + InnoDB引擎⽀持事务，⾃动保证原⼦性
        * 例：前触发、操作、后触发，任⼀失败，将⾃动回滚撤销
        * 外键维护：优先考虑级联选项
    + 不能对本表update
    + BEFORE INSERT中
        * AI自增字段的NEW值为0，因为记录尚未插入
    + 建议对触发器详细测试，再定是否使用
- 维护冗余数据
    + 尽量交应用系统（如触发器）自动维护
    + 避免数据不一致
    + 避免人工维护
    + 例如：SUM（交易金额）≠ 账户余额
```
DELIMITER $$
CREATE TRIGGER
    tr_translog_after_insert
    BEFORE INSERT ON translog
    FOR EACH ROW
BEGIN
    UPDATE account
    SET balance=balance+NEW.amount
    WHERE id=NEW.userid;
END;
$$
DELIMITER ;
```
- 模拟外键级联
    + InnoDB引擎支持外键级联选项
        * CASCADE
        * SET NULL
        * NO　ACTION
        * RESTRICT
    + 例如，若translog表设置外键级联删除。则，删除账号将导致⾃动删除交易记录
- 触发器作用
    + 安全性
        * 根据数值段或时间等，决定下一步操作
        * 例如，下班后或节假日，禁止修改（使修改失败）；不允许学生成绩为负值／大于１００分等
    + 审计
        * 相当于钩子（hook）
        * 触发器中向审计表（另外的数据表）记录用户操作
    + 复杂的数据完整性规则
        * 实现非标准的数据完整性检查和约束
        * 注（简单的完整性规则：外键级联）
            - CASCADE
            - SET NULL
            - NO ACTION
            - RESTRICT
#### 2. 事务管理
###### 事务机制概述
![事务处理举例](https://github.com/Austen-hub/Austen-hub.github.io/blob/master/basicCourse/images/%E6%95%B0%E6%8D%AE%E5%BA%93%E7%B3%BB%E7%BB%9F%E5%AE%9E%E8%B7%B5-%E4%BA%8B%E5%8A%A1%E5%A4%84%E7%90%86%E4%B8%BE%E4%BE%8B.jpg?raw=true)
###### 事务的提交和回滚
###### 事务的四大特性和隔离级别
###### 解决多用户使用的问题
